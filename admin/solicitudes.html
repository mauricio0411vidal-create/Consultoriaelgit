<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Solicitudes de contacto</title>

  <style>
    body {
      font-family: Arial, sans-serif;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #eee;
    }

    select, button, textarea {
      padding: 5px;
    }

    /* Modal */
    #modal {
      display: none;
      position: fixed;
      top: 10%;
      left: 20%;
      width: 60%;
      background: #fff;
      border: 1px solid #333;
      padding: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,.3);
    }

    #historial {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }

    .admin {
      color: blue;
    }

    .cliente {
      color: green;
    }
  </style>
</head>
<body>

<h2>Solicitudes de contacto</h2>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Nombre</th>
      <th>Correo</th>
      <th>Tel√©fono</th>
      <th>Empresa</th>
      <th>Estado</th>
      <th>Fecha</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tablaSolicitudes"></tbody>
</table>

<!-- MODAL MENSAJES -->
<div id="modal">
  <h3>Mensajes de la solicitud</h3>

  <div id="historial"></div>

  <textarea id="respuesta" placeholder="Escribe la respuesta..." style="width:100%; height:80px;"></textarea>
  <br><br>

  <button onclick="enviarRespuesta()">Enviar respuesta</button>
  <button onclick="cerrarModal()">Cerrar</button>
</div>

<script>
let solicitudActual = null;

/* =========================
   CARGAR SOLICITUDES
========================= */
fetch("/consultoria/api/admin/solicitudes_listar.php")
  .then(r => r.json())
  .then(json => {
    if (!json.ok) {
      alert("Error al cargar solicitudes");
      return;
    }

    const tbody = document.getElementById("tablaSolicitudes");
    tbody.innerHTML = "";

    json.data.forEach(s => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${s.id}</td>
        <td>${s.nombre}</td>
        <td>${s.correo}</td>
        <td>${s.telefono ?? ""}</td>
        <td>${s.empresa ?? ""}</td>
        <td>
          <select>
            <option value="NUEVO" ${s.estado==="NUEVO"?"selected":""}>NUEVO</option>
            <option value="EN_PROCESO" ${s.estado==="EN_PROCESO"?"selected":""}>EN PROCESO</option>
            <option value="CERRADO" ${s.estado==="CERRADO"?"selected":""}>CERRADO</option>
          </select>
        </td>
        <td>${s.fecha_creacion}</td>
        <td>
          <button onclick="abrirMensajes(${s.id})">Ver / Responder</button>
        </td>
      `;

      tr.querySelector("select").addEventListener("change", e => {
        actualizarEstado(s.id, e.target.value);
      });

      tbody.appendChild(tr);
    });
  });

/* =========================
   ACTUALIZAR ESTADO
========================= */
function actualizarEstado(id, estado) {
  fetch("/consultoria/api/admin/solicitud_estado.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, estado })
  })
  .then(r => r.json())
  .then(json => {
    if (!json.ok) {
      alert("Error al actualizar estado");
    }
  });
}

/* =========================
   MODAL MENSAJES
========================= */
function abrirMensajes(id) {
  solicitudActual = id;
  document.getElementById("modal").style.display = "block";
  cargarMensajes();
}

function cerrarModal() {
  document.getElementById("modal").style.display = "none";
}

/* =========================
   CARGAR HISTORIAL
========================= */
function cargarMensajes() {
  fetch(`/consultoria/api/admin/mensajes_listar.php?solicitud_id=${solicitudActual}`)
    .then(r => r.json())
    .then(json => {
      const historial = document.getElementById("historial");
      historial.innerHTML = "";

      if (!json.ok) {
        historial.innerHTML = "<p>Error al cargar mensajes</p>";
        return;
      }

      json.data.forEach(m => {
        const clase = m.tipo_remitente === "ADMIN" ? "admin" : "cliente";
        historial.innerHTML += `
          <p class="${clase}">
            <b>${m.tipo_remitente}</b>:
            ${m.mensaje}
            <br><small>${m.fecha_envio}</small>
          </p>
        `;
      });
    });
}

/* =========================
   ENVIAR RESPUESTA
========================= */
function enviarRespuesta() {
  const mensaje = document.getElementById("respuesta").value.trim();

  if (mensaje === "") {
    alert("Escribe un mensaje");
    return;
  }

  fetch("/consultoria/api/admin/solicitud_responder.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      solicitud_id: solicitudActual,
      mensaje
    })
  })
  .then(r => r.json())
  .then(json => {
    if (json.ok) {
      document.getElementById("respuesta").value = "";
      cargarMensajes();
    } else {
      alert("Error al enviar mensaje");
    }
  });
}
</script>

</body>
</html>
